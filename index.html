<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Through the Ages – Prototype</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --bg:#1e1e1e;
  --surface:#2a2a2a;
  --surface-alt:#333;
  --border:#555;
  --accent:#8ab4f8;
  --cell-size:40px; /* default; JS will override */
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:#e0e0e0;
  font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
  display:flex;
  flex-direction:column;
}

/* header unchanged */
header{
  flex:0 0 60px;
  display:flex;
  align-items:center;
  padding:0 1rem;
  background:var(--surface);
  border-bottom:1px solid var(--border);
}
header h1{font-size:1rem;font-weight:600}

/* NEW wrapper: takes remaining vertical space and centers board */
#board-wrapper{
  flex:1 1 auto;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px;
  background:var(--surface-alt);
  overflow:hidden; /* prevent scrollbars */
}

/* board is sized by --cell-size */
#board{
  display:grid;
  gap:4px;
  /* columns / rows set in JS */
  grid-template-columns:repeat(var(--cols,8),var(--cell-size));
  grid-template-rows:repeat(var(--rows,10),var(--cell-size));
}

.cell{
  width:var(--cell-size);
  height:var(--cell-size);
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:4px;
  position:relative;
}
.cell.highlight{
  outline:2px dashed var(--accent);
  outline-offset:-2px;
}

/* hand unchanged */
#hand{
  flex:0 0 160px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0.5rem;
  padding:0.5rem;
  background:var(--surface);
  border-top:1px solid var(--border);
}
.card{
  width:80px;
  height:120px;
  background:#444;
  border:2px solid var(--accent);
  border-radius:6px;
  cursor:grab;
  user-select:none;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  font-size:.8rem;
  text-align:center;
  transition:transform .05s;
}
.card small{font-size:.65rem;color:#ccc;line-height:1.1}
.card.dragging{
  opacity:.7;
  cursor:grabbing;
  transform:rotate(3deg);
}

/* ——— modal ——— */
#general-modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.85);
  backdrop-filter:blur(2px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
#general-modal.hidden{display:none;}
.modal-content{
  background:var(--surface);
  border:1px solid var(--border);
  padding:1.5rem;
  max-width:min(90vw,900px);
  max-height:min(90vh,720px);
  overflow:auto;
  border-radius:8px;
  box-shadow:0 0 10px #000;
  display:flex;
  flex-direction:column;
  gap:1rem;
}
#general-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
  gap:0.5rem;
}
.general-card{
  background:#444;
  border:2px solid transparent;
  border-radius:6px;
  padding:0.5rem;
  cursor:pointer;
  text-align:center;
  font-size:.8rem;
  user-select:none;
}
.general-card.selected{
  border-color:var(--accent);
}
#confirm-generals[disabled]{opacity:.4;cursor:not-allowed;}

  
</style>
</head>
<body>
<header><h1>Through the Ages – Prototype</h1></header>

<!-- GENERAL‑PICK MODAL -->
<div id="general-modal" class="hidden">
  <div class="modal-content">
    <h2>Select 3 Generals</h2>
    <p class="help">Click to choose 3 Generals! Click again to un‑select. Confirm when you're ready.</p>
    <div id="general-grid"></div>
    <button id="confirm-generals" disabled>Confirm</button>
  </div>
</div>

  
<main id="board-wrapper">
  <div id="board"></div>
</main>


<section id="hand"></section>

<!-- PapaParse for CSV import -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
/* ───────────────────────── CONFIG ───────────────────────── */
const boardCols = 8, boardRows = 10;

/* canonical column names – change here if your CSV differs */
const COL = {
  type : 'Type',
  sub  : 'SubType',
  color: 'Color',
  name : 'Name',       // will be updated after we inspect the header row
  real : 'RealName',   // idem
  up   : 'Up',
  down : 'Down',
  left : 'Left',
  right: 'Right'
};

/* faction ➜ hex colour */
const COLOR_HEX = {
  red       : '#d74d4d',
  blue      : '#3e86ff',
  green     : '#4f984f',
  yellow    : '#d7b542',
  brown     : '#9b6d4b',
  purple    : '#9b56d4',
  colorless : '#8a8a8a'
};

function applyColour(el, colourRaw){
  const key = String(colourRaw||'').trim().toLowerCase();
  const hex = COLOR_HEX[key] || '#888';
  el.style.borderColor = hex;
  el.style.background  = `linear-gradient(150deg, ${hex}22, ${hex}08)`;
}

/* ──────────────── DOM refs ──────────────── */
const headerEl = document.querySelector('header');
const handEl   = document.getElementById('hand');
const wrapEl   = document.getElementById('board-wrapper');
const boardEl  = document.getElementById('board');
const modalEl  = document.getElementById('general-modal');
const gridEl   = document.getElementById('general-grid');
const confirmBtn = document.getElementById('confirm-generals');

/* expose cols/rows to CSS grid template */
boardEl.style.setProperty('--cols', boardCols);
boardEl.style.setProperty('--rows', boardRows);

/* ──────────────── BUILD EMPTY BOARD ──────────────── */
for (let r = 0; r < boardRows; r++){
  for (let c = 0; c < boardCols; c++){
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.dataset.row = r; cell.dataset.col = c;
    boardEl.appendChild(cell);
  }
}

/* ──────────────── HAND PLACEHOLDERS ──────────────── */
for (let i = 0; i < 7; i++){
  const card = document.createElement('div');
  card.className = 'card';
  card.textContent = 'Blank';
  handEl.appendChild(card);
}

/* ──────────────── STATE ──────────────── */
let csvRows = [];                 // all cards
let generalsChosen = [];          // 3 rows
let allowedColors = new Set();    // updated after pick
let dragged = null;
let selectedBoardCard = null;     // card currently selected for movement

/* ───────── drag & drop ───────── */
document.addEventListener('pointerdown', e=>{
  if(!e.target.classList.contains('card')) return;
  dragged = e.target;
  dragged.classList.add('dragging');
  dragged.setPointerCapture(e.pointerId); // establish capture first
  dragged.style.pointerEvents = 'none';  // then turns off hit test
  dragged.style.zIndex = '9999'; //keeps it on top
});

document.addEventListener('pointermove', e=>{
  if(!dragged) return;

  // keep card under the pointer
  dragged.style.position = 'fixed';
  dragged.style.left = (e.clientX - 40) + 'px';   // 40 = half card width
  dragged.style.top  = (e.clientY - 60) + 'px';   // 60 = half card height

  // (optional) show potential drop cell
  document.querySelectorAll('.cell.highlight')
          .forEach(c => c.classList.remove('highlight'));

  const cell = document.elementFromPoint(e.clientX, e.clientY);
  if(cell?.classList.contains('cell') && cell.children.length === 0){
    cell.classList.add('highlight');
  }
});


document.addEventListener('pointerup', e=>{
  if(!dragged) return;
  dragged.releasePointerCapture(e.pointerId);

  const cell = document.elementFromPoint(e.clientX, e.clientY);
  const valid = cell?.classList.contains('cell') && cell.children.length === 0;

  if(valid){
    cell.appendChild(dragged);
    Object.assign(dragged.style, {position:'absolute', left:'4px', top:'4px'});
  }else{
    handEl.appendChild(dragged);
    dragged.style.position = 'static';
  }

  dragged.style.pointerEvents = 'auto';      // ➋ restore hits
  dragged.style.zIndex = ''; // resets stacking
  dragged.classList.remove('dragging');
  dragged = null;
  document.querySelectorAll('.cell.highlight').forEach(c=>c.classList.remove('highlight'));
});


/* ──────────────── BOARD CARD MOVEMENT (click‑to‑move) ──────────────── */
boardEl.addEventListener('click', e=>{
  const cardDiv = e.target.closest('.card');
  if(!cardDiv) return;
  if(cardDiv.parentElement === handEl) return;   // ignore if still in hand

  const rowId = cardDiv.dataset.rowid;
  const row   = csvRows.find(r=>r.__id === rowId);
  if(!row) return;

  if(selectedBoardCard === cardDiv){
    clearMoveHighlights();
    selectedBoardCard = null;
    return;
  }

  clearMoveHighlights();
  selectedBoardCard = cardDiv;

  const origin = cardDiv.parentElement;
  const r = +origin.dataset.row;
  const c = +origin.dataset.col;

  const moves = [];
  if(isTrue(row[COL.up])   && r>0)            moves.push({r:r-1, c});
  if(isTrue(row[COL.down]) && r<boardRows-1)  moves.push({r:r+1, c});
  if(isTrue(row[COL.left]) && c>0)            moves.push({r, c:c-1});
  if(isTrue(row[COL.right])&& c<boardCols-1)  moves.push({r, c:c+1});

  moves.forEach(({r,c})=>{
    const target = boardEl.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
    if(target && target.children.length===0){
      target.classList.add('move-target');
      target.addEventListener('click', moveListener);
    }
  });
});
function moveListener(e){
  const dest = e.currentTarget;
  dest.classList.remove('move-target');
  dest.removeEventListener('click', moveListener);

  if(selectedBoardCard){
    dest.appendChild(selectedBoardCard);
    Object.assign(selectedBoardCard.style,{position:'absolute',left:'4px',top:'4px'});
  }
  clearMoveHighlights();
  selectedBoardCard = null;
}
function clearMoveHighlights(){
  boardEl.querySelectorAll('.move-target').forEach(c=>{
    c.classList.remove('move-target');
    c.removeEventListener('click', moveListener);
  });
}

/* ──────────────── CSV LOADER ──────────────── */
function loadCardsFromCSV(path){
  Papa.parse(path,{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:({data})=>{
      if(!data.length){alert('CSV is empty');return;}
      data = data.slice(0, 376); // only rows 1-376

      /* figure out which headers map to display + real names */
      const headers = Object.keys(data[0]).map(h=>h.trim());
      COL.name = headers.find(h=>/^name$/i.test(h) && !/^realname$/i.test(h)) || headers[0];
      COL.real = headers.find(h=>/^realname$/i.test(h)) || null;

      data.forEach((row,idx)=>row.__id='id'+idx);
      csvRows = data;
      showGeneralPicker();
    }
  });
}

/* ──────────────── GENERAL PICKER (G1 → G2 → G3) ──────────────── */
function showGeneralPicker(){
  const ALL_GENERALS = csvRows.filter(r => (r[COL.type]||'').toLowerCase() === 'general');
  const STAGES       = ['G1','G2','G3'];           // order matters
  let stageIndex     = 0;                          // 0 → 2
  let chosenThisStage = null;                      // row object

  const heading   = document.getElementById('gp-heading');
  const nextBtn   = document.getElementById('gp-next');

  /** refresh grid for current stage */
  function loadStage(){
    const targetSubtype = STAGES[stageIndex];
    heading.textContent = `Select ${targetSubtype} (General ${stageIndex+1} of 3)`;
    nextBtn.disabled = true;
    nextBtn.textContent = stageIndex < 2 ? 'Next →' : 'Done';

    gridEl.innerHTML = '';   // clear previous cards

    ALL_GENERALS
      .filter(r => (r[COL.sub]||'').toUpperCase() === targetSubtype)
      .forEach(row =>{
        const card = document.createElement('div');
        card.className = 'general-card';
        card.dataset.rowid = row.__id;
        card.innerHTML = `<strong>${row[COL.name]||'?'}</strong><br><small>${row[COL.real]||''}</small>`;
        applyColour(card, row[COL.color]);
        gridEl.appendChild(card);
      });
    chosenThisStage = null;
  }

  /* click on a card */
  gridEl.addEventListener('click', e=>{
    const card = e.target.closest('.general-card');
    if(!card) return;

    gridEl.querySelectorAll('.general-card.selected')
          .forEach(el => el.classList.remove('selected'));

    card.classList.add('selected');
    chosenThisStage = csvRows.find(r => r.__id === card.dataset.rowid);
    nextBtn.disabled = false;
  });

  /* next / done button */
  nextBtn.addEventListener('click', ()=>{
    if(!chosenThisStage) return;

    generalsChosen.push(chosenThisStage);
    allowedColors.add((chosenThisStage[COL.color]||'').toLowerCase());

    if(stageIndex < 2){
      stageIndex += 1;
      loadStage();
    }else{
      // finished all three
      modalEl.classList.add('hidden');
      dealOpeningHand();
    }
  });

  // initialise
  loadStage();
  modalEl.classList.remove('hidden');
}


/* ──────────────── DEAL OPENING HAND ──────────────── */
function dealOpeningHand(){
  const legal = csvRows.filter(r=>{
    const col = (r[COL.color]||'').toLowerCase();
    return allowedColors.has(col) || col==='colorless';
  });

  const pool=[...legal], chosen=[];
  for(let i=0;i<7 && pool.length;i++){
    const idx=Math.floor(Math.random()*pool.length);
    chosen.push(pool.splice(idx,1)[0]);
  }

  [...handEl.children].forEach((cardDiv,i)=>{
    const row = chosen[i];
    if(row){
      cardDiv.dataset.rowid = row.__id;
      cardDiv.innerHTML = `${row[COL.name]||'Unknown'}<br><small>${row[COL.real]||''}</small>`;
      applyColour(cardDiv, row[COL.color]);
    }else{
      cardDiv.dataset.rowid = '';
      cardDiv.textContent = 'Unknown';
      cardDiv.style = ''; // clear any previous tint
    }
  });
}

/* ──────────────── UTIL ──────────────── */
function isTrue(val){return String(val).trim().toLowerCase()==='true' || val=='1';}

/* ──────────────── RESPONSIVE BOARD SIZING ──────────────── */
function resizeBoard(){
  const headerH = headerEl.offsetHeight;
  const handH   = handEl.offsetHeight;
  const vh      = window.innerHeight;
  const padY = 20;
  const availH = vh - headerH - handH - padY;
  const gap = 4;
  const maxCellH = (availH - (boardRows-1)*gap) / boardRows;
  const vw = wrapEl.clientWidth;
  const maxCellW = (vw - (boardCols-1)*gap) / boardCols;
  const cellSize = Math.floor(Math.min(maxCellH, maxCellW));
  document.documentElement.style.setProperty('--cell-size', cellSize+'px');
}
window.addEventListener('resize', resizeBoard);
window.addEventListener('orientationchange', resizeBoard);

/* ──────────────── INIT ──────────────── */
resizeBoard();
loadCardsFromCSV('baseset1.csv');
</script>
</body>
</html>
