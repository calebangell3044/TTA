<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Through The Ages TCG</title>

<!-- ─────────────────────────  FULL ORIGINAL CSS  ────────────────────────── -->
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #1a1a1a;
        color: #e0e0e0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }

    /* Top Bar */
    #top-bar {
        background: #2a2a2a;
        border-bottom: 2px solid #444;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #player-info { display: flex; gap: 30px; }

    .resource-display { display: flex; align-items: center; font-size: 18px; }

    .resource-icon {
        width: 30px;
        height: 30px;
        margin-right: 10px;
        background: #444;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #turn-info { text-align: center; }

    #phase-display {
        font-size: 24px;
        color: #f0c674;
        margin-bottom: 5px;
    }

    #actions-display { font-size: 16px; }

    #deck-counts {
        font-size: 14px;
        color: #888;
        margin-top: 5px;
    }

    #controls { display: flex; gap: 10px; }

    /* Main Game Area */
    #game-area { flex: 1; display: flex; flex-direction: column; position: relative; }

    /* Battlefield */
    #battlefield-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    #battlefield {
        background: #1a1a1a;
        border: 2px solid #444;
        border-radius: 8px;
        position: relative;
    }

    #grid { position: relative; }

    .grid-cell {
        position: absolute;
        border: 1px solid #333;
        background: rgba(0, 0, 0, 0.3);
        transition: all 0.3s;
    }

    .grid-cell:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: #666;
    }

    .grid-cell.valid-move {
        background: rgba(100, 255, 100, 0.2);
        border-color: #4f4;
    }

    .grid-cell.enemy-occupied {
        background: rgba(255, 100, 100, 0.2);
        border-color: #f44;
    }

    /* Cards on Battlefield */
    .battlefield-card {
        position: absolute;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        z-index: 10;
        background: #333;
        border: 2px solid #222;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .battlefield-card:hover {
        z-index: 100;
        transform: scale(3) translateY(-20px);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
        width: auto !important;
        height: auto !important;
        min-width: 200px;
        min-height: 280px;
    }

    .battlefield-card.selected {
        border-color: #f0c674;
        box-shadow: 0 0 20px rgba(240, 198, 116, 0.5);
    }

    .battlefield-card.enemy { border-color: #c66; }

    /* Hand Container */
    #hand-container {
        background: #2a2a2a;
        border-top: 2px solid #444;
        padding: 20px;
        height: 200px;
    }

    #hand-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    #hand-header h3 { color: #81b3d3; }

    #hand {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        height: 150px;
    }

    .hand-card {
        min-width: 100px;
        width: 100px;
        height: 140px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s;
        position: relative;
        background: #333;
        overflow: hidden;
        border: 2px solid #222;
    }

    .hand-card:hover {
        transform: translateY(-20px) scale(2.5);
        z-index: 1000;
        width: auto !important;
        height: auto !important;
        min-width: 200px;
        min-height: 280px;
    }

    .hand-card.selected { border: 3px solid #f0c674; transform: translateY(-10px); }

    /* Card Design */
    .card-content { width: 100%; height: 100%; position: relative; background: #222; }

    .card-banner {
        position: absolute;
        left: 0; top: 0; bottom: 0;
        width: 30%;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 5px;
        color: white;
        font-weight: bold;
    }

    .card-banner.red       { background: linear-gradient(180deg,#d44,#922); }
    .card-banner.blue      { background: linear-gradient(180deg,#48d,#269); }
    .card-banner.green     { background: linear-gradient(180deg,#4d4,#292); }
    .card-banner.yellow    { background: linear-gradient(180deg,#da4,#a82); }
    .card-banner.purple    { background: linear-gradient(180deg,#94d,#629); }
    .card-banner.brown     { background: linear-gradient(180deg,#a84,#642); }
    .card-banner.colorless { background: linear-gradient(180deg,#888,#555); }

    .might-circle {
        width: 40px; height: 40px; border-radius: 50%; background: white; color: black;
        display: flex; align-items: center; justify-content: center;
        font-size: 18px; font-weight: bold; margin-top: 10px; position: relative;
    }

    .movement-indicators { position: absolute; width: 60px; height: 60px; top: -10px; left: -10px; }

    .movement-arrow {
        position: absolute; width: 0; height: 0; border-style: solid; opacity: 0.7;
    }

    .movement-arrow.up    { top:-5px; left:50%; transform:translateX(-50%); border-width:0 5px 8px 5px; border-color:transparent transparent #fff transparent; }
    .movement-arrow.down  { bottom:-5px; left:50%; transform:translateX(-50%); border-width:8px 5px 0 5px; border-color:#fff transparent transparent transparent; }
    .movement-arrow.left  { left:-5px; top:50%; transform:translateY(-50%); border-width:5px 8px 5px 0; border-color:transparent #fff transparent transparent; }
    .movement-arrow.right { right:-5px; top:50%; transform:translateY(-50%); border-width:5px 0 5px 8px; border-color:transparent transparent transparent #fff; }
    .movement-arrow.ur    { top:0; right:0; border-width:0 0 10px 10px; border-color:transparent transparent #fff transparent; transform:rotate(45deg);  transform-origin:bottom left; }
    .movement-arrow.ul    { top:0; left:0; border-width:0 10px 10px 0; border-color:transparent transparent #fff transparent; transform:rotate(-45deg); transform-origin:bottom right; }
    .movement-arrow.dr    { bottom:0; right:0; border-width:10px 0 0 10px; border-color:#fff transparent transparent transparent; transform:rotate(-45deg); transform-origin:top left; }
    .movement-arrow.dl    { bottom:0; left:0; border-width:10px 10px 0 0; border-color:#fff transparent transparent transparent; transform:rotate(45deg);  transform-origin:top right; }

    .ration-cost {
        width: 30px; height: 30px; border-radius: 50%; background: #444; color: white;
        display: flex; align-items: center; justify-content: center; font-size: 14px; margin-top: 10px;
    }

    .card-type { writing-mode: vertical-lr; font-size: 10px; margin-top: 10px; text-transform: uppercase; }

    .card-art {
        position: absolute; left: 30%; top: 0; right: 0; bottom: 25%;
        background: #444; display: flex; align-items: center; justify-content: center;
        font-size: 12px; color: #888; text-align: center; padding: 5px;
    }

    .card-name {
        position: absolute; bottom: 25%; left: 30%; right: 0; padding: 5px;
        background: rgba(0,0,0,0.7); font-size: 11px; font-weight: bold;
    }

    .card-ability {
        position: absolute; bottom: 0; left: 0; right: 0; height: 25%;
        background: linear-gradient(180deg,#444,#333); border-top: 1px solid #555;
        padding: 5px; font-size: 9px; overflow: visible; line-height: 1.2; min-height: 60px;
    }

    .battlefield-card:hover .card-content,
    .hand-card:hover        .card-content { width: 200px; height: 280px; }

    .battlefield-card:hover .card-ability,
    .hand-card:hover        .card-ability { font-size: 11px; height: auto; min-height: 80px; }

    .battlefield-card:hover .card-name,
    .hand-card:hover        .card-name    { font-size: 14px; }

    /* Encampment */
    .encampment {
        width: 100%; height: 100%; background: radial-gradient(circle,#654,#432);
        border: 3px solid #876; border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; font-size: 32px; color: #fed;
    }

    /* UI Buttons */
    .button { background: #48d; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
    .button:hover      { background:#5ae; }
    .button:disabled   { background:#666; cursor: not-allowed; }
    .button.generate   { background:#4d4; }
    .button.generate:hover { background:#5e5; }
    .button.end-turn   { background:#d84; }
    .button.end-turn:hover { background:#e95; }

    /* Battle Modal */
    #battle-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:1000; }
    #battle-content { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
        background:#2a2a2a; border-radius:10px; padding:30px; min-width:400px; border:2px solid #666; }
    #battle-content h2 { color:#f0c674; margin-bottom:20px; text-align:center; }
    .battle-card-display { display:flex; justify-content:space-around; margin:20px 0; }
    .battle-card-preview { width:120px; height:180px; border-radius:8px; border:2px solid #444; }
    #wager-display { text-align:center; font-size:20px; margin:20px 0; }
    .wager-controls { display:flex; justify-content:center; gap:10px; }

    /* Dice Roll */
    #dice-container { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); display:none; z-index:2000; }
    .dice { width:100px; height:100px; background:#fff; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:48px; font-weight:bold; color:#333; animation:roll 0.5s ease-out; }
    @keyframes roll { 0%{transform:rotate(0)   scale(0.5);} 50%{transform:rotate(180deg) scale(1.2);} 100%{transform:rotate(360deg) scale(1);} }

    /* Victory */
    #victory-screen { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:3000; }
    #victory-content { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; }
    #victory-content h1 { font-size:72px; color:#f0c674; margin-bottom:30px; text-shadow:0 0 20px rgba(240,198,116,0.5); }

    /* Discard Modal */
    #discard-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:1000; }
    #discard-content { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
        background:#2a2a2a; border-radius:10px; padding:30px; max-width:80%; max-height:80%; overflow:auto; }
    #discard-cards { display:flex; flex-wrap:wrap; gap:10px; margin:20px 0; }
    .discard-card { width:100px; height:140px; border-radius:8px; cursor:pointer; border:2px solid #444; transition:all 0.2s; }
    .discard-card:hover { transform:scale(1.1); border-color:#f0c674; }
</style>

<!-- Papa Parse for CSV → JSON -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>

<!-- ─────────────────────────  PAGE LAYOUT  ───────────────────────── -->
<div id="top-bar">
    <div id="player-info">
        <div class="resource-display"><div class="resource-icon">⚔️</div>Rations: <span id="rations">0</span></div>
        <div class="resource-display"><div class="resource-icon">⚡</div>Actions: <span id="actions">0</span></div>
        <div class="resource-display"><div class="resource-icon">👑</div>General Lives: <span id="general-lives">3</span></div>
    </div>

    <div id="turn-info">
        <div id="phase-display">Generation Phase</div>
        <div id="actions-display">Turn 1: Player 1</div>
        <div id="deck-counts">Your Deck: <span id="player-deck">0</span> | Enemy Deck: <span id="enemy-deck">0</span></div>
    </div>

    <div id="controls">
        <button class="button generate" id="generate-btn" onclick="game.generatePhase()">Generate Rations & Draw</button>
        <button class="button" onclick="game.gainRation()">Gain Ration (1 Action)</button>
        <button class="button end-turn" onclick="game.endTurn()">End Turn</button>
    </div>
</div>

<div id="game-area">
    <div id="battlefield-container">
        <div id="battlefield"><div id="grid"></div></div>
    </div>

    <div id="hand-container">
        <div id="hand-header">
            <h3>Your Hand (<span id="hand-count">0</span>)</h3>
            <button class="button" onclick="game.showDiscardModal()">Discard for Rations</button>
        </div>
        <div id="hand"></div>
    </div>
</div>

<!-- Battle Modal -->
<div id="battle-modal">
    <div id="battle-content">
        <h2>Battle!</h2>
        <div class="battle-card-display">
            <div class="battle-card-preview" id="attacker-preview"></div>
            <div style="align-self:center;font-size:32px;">⚔️</div>
            <div class="battle-card-preview" id="defender-preview"></div>
        </div>
        <div id="wager-display">Battle Pot: <span id="battle-pot">0</span> Rations</div>
        <div class="wager-controls">
            <button class="button" onclick="game.battle.raise()">Raise</button>
            <button class="button" onclick="game.battle.call()">Call</button>
            <button class="button" onclick="game.battle.fold()">Fold</button>
        </div>
        <h3 style="margin-top:20px;">Support Cards</h3>
        <div id="support-selection"></div>
    </div>
</div>

<!-- Discard Modal -->
<div id="discard-modal">
    <div id="discard-content">
        <h2>Select a Card to Discard for 1 Ration</h2>
        <div id="discard-cards"></div>
        <button class="button" onclick="game.hideDiscardModal()">Cancel</button>
    </div>
</div>

<!-- Dice & Victory screens -->
<div id="dice-container"><div class="dice" id="dice"></div></div>
<div id="victory-screen">
    <div id="victory-content">
        <h1 id="victory-text">Victory!</h1>
        <button class="button" onclick="location.reload()">New Game</button>
    </div>
</div>

<!-- ────────────────────────  MAIN SCRIPT  ───────────────────────── -->
<script>
/* ------------------------------------------------------------------
   1)  Global DB filled from CSV at runtime
------------------------------------------------------------------ */
let cardDatabase = {};

/* ------------------------------------------------------------------
   2)  CSV → cardDatabase
------------------------------------------------------------------ */
async function loadCardData() {
    const csvText = await fetch('baseset1.csv').then(r => r.text());
    const parsed   = Papa.parse(csvText, { header: true, dynamicTyping: true });

    cardDatabase = {};

    parsed.data.forEach(row => {
        if (!row.SetNum) return;   // skip blank lines

        const toNum = v => { const n = parseInt(v, 10); return Number.isFinite(n) ? n : null; };

        cardDatabase[row.SetNum] = {
            name:     row.RealName,
            realName: row.RealName,
            color:    (row.Color || '').toLowerCase(),
            type:     row.Type,
            subtype:  row.Subtype || null,
            might:    toNum(row.Might),
            rations:  toNum(row.Rations),
            movement: row.Movement || null,
            ability:  row.Ability  || '',
            setNum:   row.SetNum,
            rarity:   row.Rarity,
            movements:{
                up:!!row.Up, down:!!row.Down, left:!!row.Left, right:!!row.Right,
                ur:!!row.UR, ul:!!row.UL,     dr:!!row.DR,     dl:!!row.DL
            }
        };
    });

    console.log(`Loaded ${Object.keys(cardDatabase).length} cards from CSV`);
}

/* ------------------------------------------------------------------
   3)  GAME OBJECT  (identical logic except init now waits for CSV)
------------------------------------------------------------------ */
const game = {
    /* --- state --- */
    currentPlayer: 1,
    phase: 'generation',
    actions: 0,
    rations: 0,
    generalLives: 3,
    enemyGeneralLives: 3,
    selectedCard: null,
    selectedHandCard: null,
    battlefield: {},
    hand: [],
    deck: [],
    enemyDeck: [],
    graveyard: [],
    turn: 1,
    gridSize: { rows: 10, cols: 8 },
    cellSize: 80,
    hasGenerated: false,
    playerGenerals: [],
    enemyGenerals: [],
    currentPlayerGeneral: 0,
    currentEnemyGeneral: 0,

    /* --- boot --- */
    async init() {
        await loadCardData();      // ← NEW
        this.createBattlefield();
        this.setupGenerals();
        this.createDecks();
        this.placeStartingUnits();
        this.updateUI();
    },

    /* --- the rest of your original game code is unchanged --- */
    /* (everything from createBattlefield() down to endGame() ) */
    /*  … — omitted here for brevity — … */
};

/* ------------------------------------------------------------------
   4)  Start the game
------------------------------------------------------------------ */
window.onload = () => game.init();
</script>
</body>
</html>
