<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Through the Ages – Prototype</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --bg:#1e1e1e;
  --surface:#2a2a2a;
  --surface-alt:#333;
  --border:#555;
  --accent:#8ab4f8;
  --cell-size:40px; /* default; JS will override */
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:#e0e0e0;
  font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
  display:flex;
  flex-direction:column;
}

/* header unchanged */
header{
  flex:0 0 60px;
  display:flex;
  align-items:center;
  padding:0 1rem;
  background:var(--surface);
  border-bottom:1px solid var(--border);
}
header h1{font-size:1rem;font-weight:600}

/* NEW wrapper: takes remaining vertical space and centers board */
#board-wrapper{
  flex:1 1 auto;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px;
  background:var(--surface-alt);
  overflow:hidden; /* prevent scrollbars */
}

/* board is sized by --cell-size */
#board{
  display:grid;
  gap:4px;
  /* columns / rows set in JS */
  grid-template-columns:repeat(var(--cols,8),var(--cell-size));
  grid-template-rows:repeat(var(--rows,10),var(--cell-size));
}

.cell{
  width:var(--cell-size);
  height:var(--cell-size);
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:4px;
  position:relative;
}
.cell.highlight{
  outline:2px dashed var(--accent);
  outline-offset:-2px;
}

/* hand unchanged */
#hand{
  flex:0 0 160px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0.5rem;
  padding:0.5rem;
  background:var(--surface);
  border-top:1px solid var(--border);
}
.card{
  width:80px;
  height:120px;
  background:#444;
  border:2px solid var(--accent);
  border-radius:6px;
  cursor:grab;
  user-select:none;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  font-size:.8rem;
  text-align:center;
  transition:transform .05s;
}
.card small{font-size:.65rem;color:#ccc;line-height:1.1}
.card.dragging{
  opacity:.7;
  cursor:grabbing;
  transform:rotate(3deg);
}
</style>
</head>
<body>
<header><h1>Through the Ages – Prototype</h1></header>

<main id="board-wrapper">
  <div id="board"></div>
</main>


<section id="hand"></section>

<!-- PapaParse for CSV import -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
/* grid size */
const boardCols = 8, boardRows = 10;

/* DOM refs */
const headerEl = document.querySelector('header');
const handEl   = document.getElementById('hand');
const wrapEl   = document.getElementById('board-wrapper');
const boardEl  = document.getElementById('board');

/* expose cols/rows as CSS custom props (used in grid templates) */
boardEl.style.setProperty('--cols', boardCols);
boardEl.style.setProperty('--rows', boardRows);

/* build board cells */
for (let r = 0; r < boardRows; r++){
  for (let c = 0; c < boardCols; c++){
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.dataset.row = r; cell.dataset.col = c;
    boardEl.appendChild(cell);
  }
}

/* build 7 placeholder cards in hand */
for (let i = 0; i < 7; i++){
  const card = document.createElement('div');
  card.className = 'card';
  card.textContent = 'Blank';
  handEl.appendChild(card);
}

/* drag & drop */
let dragged = null;
document.addEventListener('pointerdown', e=>{
  if(!e.target.classList.contains('card')) return;
  dragged = e.target;
  dragged.classList.add('dragging');
  dragged.setPointerCapture(e.pointerId);
});
document.addEventListener('pointermove', e=>{
  if(!dragged) return;
  Object.assign(dragged.style,{
    position:'fixed',
    left:(e.clientX-40)+'px',
    top :(e.clientY-60)+'px'
  });
  document.querySelectorAll('.cell.highlight').forEach(c=>c.classList.remove('highlight'));
  const cell = document.elementFromPoint(e.clientX,e.clientY);
  if(cell?.classList.contains('cell') && cell.children.length===0) cell.classList.add('highlight');
});
document.addEventListener('pointerup', e=>{
  if(!dragged) return;
  dragged.releasePointerCapture(e.pointerId);
  const cell = document.elementFromPoint(e.clientX,e.clientY);
  const valid = cell?.classList.contains('cell') && cell.children.length===0;
  if(valid){
    cell.appendChild(dragged);
    Object.assign(dragged.style,{position:'absolute',left:'4px',top:'4px'});
  }else{
    handEl.appendChild(dragged);
    dragged.style.position='static';
  }
  dragged.classList.remove('dragging');
  dragged = null;
  document.querySelectorAll('.cell.highlight').forEach(c=>c.classList.remove('highlight'));
});

/* CSV loader: random 7 cards, show Name(top) + RealName(bottom) */
function loadCardsFromCSV(path){
  Papa.parse(path,{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:({data})=>{
      if(!data.length){console.warn('CSV is empty');return;}
      const headers = Object.keys(data[0]);

      /* explicit detection per your latest note */
      const displayKey = headers.find(h => /^name$/i.test(h)) ||
                         headers.find(h => /^cardname$/i.test(h)) ||
                         headers[0];
      const realKey    = headers.find(h => /^realname$/i.test(h)); // exact RealName

      /* pick 7 unique random rows */
      const pool=[...data], chosen=[];
      for(let i=0;i<7 && pool.length;i++){
        const idx=Math.floor(Math.random()*pool.length);
        chosen.push(pool.splice(idx,1)[0]);
      }

      /* populate hand */
      [...handEl.children].forEach((card,i)=>{
        const row = chosen[i] || {};
        const disp = row[displayKey] || 'Unknown';
        const real = realKey ? row[realKey] || '' : '';
        card.innerHTML = real
          ? `${disp}<br><small>${real}</small>`
          : disp;
      });

      console.log('Hand populated:', {displayKey, realKey});
    }
  });
}

/* responsive board sizing */
function resizeBoard(){
  // available vertical space in wrapper
  const headerH = headerEl.offsetHeight;
  const handH   = handEl.offsetHeight;
  const vh      = window.innerHeight;

  // subtract header + hand + wrapper padding (20px top/bottom)
  const padY = 20; // matches #board-wrapper padding:10px top + bottom
  const availH = vh - headerH - handH - padY;

  // each row needs a cell + gap (4px). last row has no extra gap after it,
  // but safe to approximate rows*cell + (rows-1)*gap => rows*cell + gapsTotal
  const gap = 4;
  const maxCellH = (availH - (boardRows-1)*gap) / boardRows;

  // width constraint
  const vw = wrapEl.clientWidth;
  const maxCellW = (vw - (boardCols-1)*gap) / boardCols;

  // choose the smaller to ensure fit
  const cellSize = Math.floor(Math.min(maxCellH, maxCellW));

  document.documentElement.style.setProperty('--cell-size', cellSize+'px');
}
window.addEventListener('resize', resizeBoard);
window.addEventListener('orientationchange', resizeBoard);

/* init */
resizeBoard();
loadCardsFromCSV('baseset1.csv');
</script>
</body>
</html>
