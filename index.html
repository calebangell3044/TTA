<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Through the Ages – Prototype</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --bg:#1e1e1e;
  --surface:#2a2a2a;
  --surface-alt:#333;
  --border:#555;
  --accent:#8ab4f8;
  --cell-size:40px; /* default; JS will override */
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:#e0e0e0;
  font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
  display:flex;
  flex-direction:column;
}

/* header unchanged */
header{
  flex:0 0 60px;
  display:flex;
  align-items:center;
  padding:0 1rem;
  background:var(--surface);
  border-bottom:1px solid var(--border);
}
header h1{font-size:1rem;font-weight:600}

/* NEW wrapper: takes remaining vertical space and centers board */
#board-wrapper{
  flex:1 1 auto;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px;
  background:var(--surface-alt);
  overflow:hidden; /* prevent scrollbars */
}

/* board is sized by --cell-size */
#board{
  display:grid;
  gap:4px;
  /* columns / rows set in JS */
  grid-template-columns:repeat(var(--cols,8),var(--cell-size));
  grid-template-rows:repeat(var(--rows,10),var(--cell-size));
}

.cell{
  width:var(--cell-size);
  height:var(--cell-size);
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:4px;
  position:relative;
}
.cell.highlight{
  outline:2px dashed var(--accent);
  outline-offset:-2px;
}

/* hand unchanged */
#hand{
  flex:0 0 160px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0.5rem;
  padding:0.5rem;
  background:var(--surface);
  border-top:1px solid var(--border);
}
.card{
  width:80px;
  height:120px;
  background:#444;
  border:2px solid var(--accent);
  border-radius:6px;
  cursor:grab;
  user-select:none;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  font-size:.8rem;
  text-align:center;
  transition:transform .05s;
}
.card small{font-size:.65rem;color:#ccc;line-height:1.1}
.card.dragging{
  opacity:.7;
  cursor:grabbing;
  transform:rotate(3deg);
}

/* ——— modal ——— */
#general-modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.85);
  backdrop-filter:blur(2px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
#general-modal.hidden{display:none;}
.modal-content{
  background:var(--surface);
  border:1px solid var(--border);
  padding:1.5rem;
  max-width:min(90vw,900px);
  max-height:min(90vh,720px);
  overflow:auto;
  border-radius:8px;
  box-shadow:0 0 10px #000;
  display:flex;
  flex-direction:column;
  gap:1rem;
}
#general-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
  gap:0.5rem;
}
.general-card{
  background:#444;
  border:2px solid transparent;
  border-radius:6px;
  padding:0.5rem;
  cursor:pointer;
  text-align:center;
  font-size:.8rem;
  user-select:none;
}
.general-card.selected{
  border-color:var(--accent);
}
#confirm-generals[disabled]{opacity:.4;cursor:not-allowed;}

.gp-footer{
  margin-top:auto;
  display:flex;
  justify-content:flex-end;
}

#deck-hud{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:1rem;
}
#btn-draw{
  padding:.3rem .8rem;
  background:var(--accent);
  color:#000;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-weight:600;
}
#btn-draw:disabled{opacity:.4;cursor:not-allowed;}

  
</style>
</head>
<body>
<header>
  <h1>Through the Ages – Prototype</h1>

  <div id="deck-hud">
    <span id="deck-count">Deck – (0 + hand = 50)</span>
    <button id="btn-draw" disabled>Draw Card</button>
  </div>
</header>

<!-- GENERAL‑PICK MODAL -->
<div id="general-modal" class="hidden">
  <div class="modal-content">
    <h2 id="gp-heading">Select General 1 of 3</h2>

    <div id="general-grid"></div>

    <div class="gp-footer">
      <button id="gp-next" disabled>Next →</button>
    </div>
  </div>
</div>


  
<main id="board-wrapper">
  <div id="board"></div>
</main>


<section id="hand"></section>

<!-- PapaParse for CSV import -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
/* ───────────────────────── CONFIG ───────────────────────── */
const boardCols = 8, boardRows = 10;

/* canonical column names – change here if your CSV differs */
const COL = {
  type : 'Type',
  sub  : 'Subtype',         // auto‑detected later if casing differs
  color: 'Color',
  name : 'Name',            // will be updated after we inspect header row
  real : 'RealName',        // idem
  up   : 'Up',
  down : 'Down',
  left : 'Left',
  right: 'Right'
};

/* faction ➜ hex colour */
const COLOR_HEX = {
  red       : '#d74d4d',
  blue      : '#3e86ff',
  green     : '#4f984f',
  yellow    : '#d7b542',
  brown     : '#9b6d4b',
  purple    : '#9b56d4',
  colorless : '#8a8a8a'
};
function applyColour(el, colourRaw){
  const key = String(colourRaw||'').trim().toLowerCase();
  const hex = COLOR_HEX[key] || '#888';
  el.style.borderColor = hex;
  el.style.background  = `linear-gradient(150deg, ${hex}22, ${hex}08)`;
}

/* ──────────────── DOM refs ──────────────── */
const headerEl = document.querySelector('header');
const handEl   = document.getElementById('hand');
const wrapEl   = document.getElementById('board-wrapper');
const boardEl  = document.getElementById('board');
const modalEl  = document.getElementById('general-modal');
const gridEl   = document.getElementById('general-grid');
const nextBtn  = document.getElementById('gp-next');      // modal button
const headingEl= document.getElementById('gp-heading');   // modal heading
const deckCountEl = document.getElementById('deck-count');
const drawBtn  = document.getElementById('btn-draw');

/* expose cols/rows to CSS grid template */
boardEl.style.setProperty('--cols', boardCols);
boardEl.style.setProperty('--rows', boardRows);

/* ──────────────── BUILD EMPTY BOARD ──────────────── */
for (let r = 0; r < boardRows; r++){
  for (let c = 0; c < boardCols; c++){
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.dataset.row = r; cell.dataset.col = c;
    boardEl.appendChild(cell);
  }
}

/* ──────────────── STATE ──────────────── */
let csvRows = [];                 // all rows from CSV (trimmed to 376)
let generalsChosen = [];          // 3 rows
let allowedColors  = new Set();   // colours allowed in deck
let fullDeck   = [];              // 50‑card deck (rows)
let dragged = null;
let selectedBoardCard = null;     // card selected to move

/* ──────────────── HUD update ──────────────── */
function updateDeckHUD(){
  const deckLeft = fullDeck.length;
  const handCnt  = handEl.children.length;
  deckCountEl.textContent = `Deck – (${deckLeft} + hand = ${handCnt})`;
  drawBtn.disabled = deckLeft === 0;
}

/* ───────── drag & drop ───────── */
document.addEventListener('pointerdown', e=>{
  if(!e.target.classList.contains('card')) return;
  dragged = e.target;
  dragged.classList.add('dragging');
  dragged.setPointerCapture(e.pointerId);       // capture first
  dragged.style.pointerEvents = 'none';
  dragged.style.zIndex = '9999';
});

document.addEventListener('pointermove', e=>{
  if(!dragged) return;
  dragged.style.position = 'fixed';
  dragged.style.left = (e.clientX - 40) + 'px';
  dragged.style.top  = (e.clientY - 60) + 'px';

  document.querySelectorAll('.cell.highlight')
          .forEach(c => c.classList.remove('highlight'));

  const cell = document.elementFromPoint(e.clientX, e.clientY);
  if(cell?.classList.contains('cell') && cell.children.length === 0){
    cell.classList.add('highlight');
  }
});

document.addEventListener('pointerup', e=>{
  if(!dragged) return;
  dragged.releasePointerCapture(e.pointerId);

  const cell = document.elementFromPoint(e.clientX, e.clientY);
  const valid = cell?.classList.contains('cell') && cell.children.length === 0;

  if(valid){
    cell.appendChild(dragged);
    Object.assign(dragged.style,{position:'absolute',left:'4px',top:'4px'});
  }else{
    handEl.appendChild(dragged);
    dragged.style.position = 'static';
  }

  dragged.style.pointerEvents = 'auto';
  dragged.style.zIndex = '';
  dragged.classList.remove('dragging');
  dragged = null;
  document.querySelectorAll('.cell.highlight').forEach(c=>c.classList.remove('highlight'));

  updateDeckHUD();                       // hand size changed
});

/* ──────────────── BOARD CARD MOVEMENT (click‑to‑move) ──────────────── */
/*   -- unchanged from your version, but updateDeckHUD not needed here  */
boardEl.addEventListener('click', e=>{
  const cardDiv = e.target.closest('.card');
  if(!cardDiv || cardDiv.parentElement === handEl) return;

  const rowId = cardDiv.dataset.rowid;
  const row   = csvRows.find(r=>r.__id === rowId);
  if(!row) return;

  if(selectedBoardCard === cardDiv){
    clearMoveHighlights();
    selectedBoardCard = null;
    return;
  }

  clearMoveHighlights();
  selectedBoardCard = cardDiv;
  const origin = cardDiv.parentElement;
  const r = +origin.dataset.row, c = +origin.dataset.col;

  const moves = [];
  if(isTrue(row[COL.up])   && r>0)            moves.push({r:r-1, c});
  if(isTrue(row[COL.down]) && r<boardRows-1)  moves.push({r:r+1, c});
  if(isTrue(row[COL.left]) && c>0)            moves.push({r, c:c-1});
  if(isTrue(row[COL.right])&& c<boardCols-1)  moves.push({r, c:c+1});

  moves.forEach(({r,c})=>{
    const target = boardEl.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
    if(target && target.children.length===0){
      target.classList.add('move-target');
      target.addEventListener('click', moveListener);
    }
  });
});
function moveListener(e){
  const dest = e.currentTarget;
  dest.classList.remove('move-target');
  dest.removeEventListener('click', moveListener);

  if(selectedBoardCard){
    dest.appendChild(selectedBoardCard);
    Object.assign(selectedBoardCard.style,{position:'absolute',left:'4px',top:'4px'});
  }
  clearMoveHighlights();
  selectedBoardCard = null;
}
function clearMoveHighlights(){
  boardEl.querySelectorAll('.move-target').forEach(c=>{
    c.classList.remove('move-target');
    c.removeEventListener('click', moveListener);
  });
}

/* ──────────────── DRAW BUTTON ──────────────── */
drawBtn.addEventListener('click', ()=>{
  if(fullDeck.length === 0) return;
  const row = fullDeck.shift();
  const cardDiv = document.createElement('div');
  cardDiv.className = 'card';
  cardDiv.dataset.rowid = row.__id;
  cardDiv.innerHTML = `${row[COL.name]||'Unknown'}<br><small>${row[COL.real]||''}</small>`;
  applyColour(cardDiv, row[COL.color]);
  handEl.appendChild(cardDiv);
  updateDeckHUD();
});

/* ──────────────── CSV LOADER ──────────────── */
function loadCardsFromCSV(path){
  Papa.parse(path,{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:({data})=>{
      if(!data.length){alert('CSV is empty');return;}
      data = data.slice(0, 376);

      const headers = Object.keys(data[0]).map(h=>h.trim());
      COL.name = headers.find(h=>/^name$/i.test(h) && !/^realname$/i.test(h)) || headers[0];
      COL.real = headers.find(h=>/^realname$/i.test(h)) || null;
      COL.sub  = headers.find(h=>/^sub[\s_]*type$/i.test(h)) || COL.sub;

      data.forEach((row,idx)=>row.__id='id'+idx);
      csvRows = data;
      showGeneralPicker();
    }
  });
}

/* ──────────────── GENERAL PICKER (G1 → G2 → G3) ──────────────── */
function showGeneralPicker(){
  const ALL_GENS = csvRows.filter(r => (r[COL.type]||'').toLowerCase() === 'general');
  const STAGES   = ['G1','G2','G3'];
  let idx = 0, chosenRow = null;

  function loadStage(){
    const target = STAGES[idx];
    headingEl.textContent = `Select ${target} (General ${idx+1} of 3)`;
    nextBtn.disabled = true;
    nextBtn.textContent = idx < 2 ? 'Next →' : 'Done';
    gridEl.innerHTML = '';

    ALL_GENS.filter(r => String(r[COL.sub]||'').trim().toUpperCase() === target)
            .forEach(row=>{
               const div = document.createElement('div');
               div.className='general-card';
               div.dataset.rowid=row.__id;
               div.innerHTML = `<strong>${row[COL.name]}</strong><br><small>${row[COL.real]||''}</small>`;
               applyColour(div, row[COL.color]);
               gridEl.appendChild(div);
            });
    chosenRow = null;
  }

  gridEl.addEventListener('click', e=>{
    const card = e.target.closest('.general-card');
    if(!card) return;
    gridEl.querySelectorAll('.general-card.selected')
          .forEach(el=>el.classList.remove('selected'));
    card.classList.add('selected');
    chosenRow = csvRows.find(r=>r.__id===card.dataset.rowid);
    nextBtn.disabled = false;
  });

  nextBtn.addEventListener('click', ()=>{
    if(!chosenRow) return;
    generalsChosen.push(chosenRow);
    allowedColors.add((chosenRow[COL.color]||'').toLowerCase());

    if(idx < 2){
      idx += 1;
      loadStage();
    }else{
      modalEl.classList.add('hidden');
      buildDeckAndStart();
    }
  });

  loadStage();
  modalEl.classList.remove('hidden');
}

/* ──────────────── BUILD 50‑CARD DECK & DEAL HAND ──────────────── */
function buildDeckAndStart(){
  const legal = csvRows.filter(r=>{
    const col = (r[COL.color]||'').toLowerCase();
    return allowedColors.has(col) || col === 'colorless';
  });

  if(legal.length < 50) alert('Warning: fewer than 50 legal cards – duplicates will occur');

  // shuffle copy, then slice
  fullDeck = [...legal].sort(()=>Math.random()-0.5);
  while(fullDeck.length < 50) fullDeck.push(...fullDeck);
  fullDeck = fullDeck.slice(0,50);

  handEl.innerHTML = '';          // clear placeholders
  dealOpeningHand();              // pops first 7
  updateDeckHUD();
}

/* ──────────────── DEAL OPENING HAND (pops from fullDeck) ──────────────── */
function dealOpeningHand(){
  for(let i=0;i<7;i++){
    const row = fullDeck.shift();
    if(!row) break;
    const cardDiv = document.createElement('div');
    cardDiv.className='card';
    cardDiv.dataset.rowid=row.__id;
    cardDiv.innerHTML=`${row[COL.name]||'Unknown'}<br><small>${row[COL.real]||''}</small>`;
    applyColour(cardDiv, row[COL.color]);
    handEl.appendChild(cardDiv);
  }
}

/* ──────────────── UTIL ──────────────── */
function isTrue(val){return String(val).trim().toLowerCase()==='true' || val=='1';}

/* ──────────────── RESPONSIVE BOARD SIZING ──────────────── */
function resizeBoard(){
  const headerH = headerEl.offsetHeight;
  const handH   = handEl.offsetHeight;
  const vh      = window.innerHeight;
  const padY = 20;
  const availH = vh - headerH - handH - padY;
  const gap = 4;
  const maxCellH = (availH - (boardRows-1)*gap) / boardRows;
  const vw = wrapEl.clientWidth;
  const maxCellW = (vw - (boardCols-1)*gap) / boardCols;
  document.documentElement.style.setProperty('--cell-size',
    Math.floor(Math.min(maxCellH, maxCellW))+'px');
}
window.addEventListener('resize', resizeBoard);
window.addEventListener('orientationchange', resizeBoard);

/* ──────────────── INIT ──────────────── */
resizeBoard();
loadCardsFromCSV('baseset1.csv');
</script>
</body>
</html>
